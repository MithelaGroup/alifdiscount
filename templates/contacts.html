{% extends "base.html" %}

{% block title %}Contacts{% endblock %}

{% block content %}
<section class="section">
  <div class="page-head">
    <h1>üìá Contacts</h1>
    <div class="actions">
      <button id="btnOpenContact" class="btn btn-primary">‚ûï Create Contact</button>
    </div>
  </div>

  {% if request.query_params.get('err') == 'mobile' %}
  <div class="alert alert-danger">Invalid mobile format. Please use <strong>+8801XXXXXXXXX</strong>.</div>
  {% endif %}

  {% if total == 0 %}
    <p class="muted">No contacts yet.</p>
  {% else %}
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th style="width:70px">SL</th>
            <th>Full name</th>
            <th>Mobile</th>
            <th>Remark</th>
          </tr>
        </thead>
        <tbody>
        {% for r in rows %}
          <tr>
            <td>{{ (page - 1) * per_page + loop.index }}</td>
            <td>{{ r.full_name }}</td>
            <td>{{ r.mobile }}</td>
            <td>{{ r.remark }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="pager">
      <div class="muted">
        Showing {{ (page - 1) * per_page + 1 }}‚Äì{{ (page - 1) * per_page + rows|length }} of {{ total }}
      </div>
      <div>
        {% if page > 1 %}
          <a class="btn btn-secondary" href="/contacts?page={{ page - 1 }}&per_page={{ per_page }}">‚Üê Prev</a>
        {% endif %}
        <span class="muted">Page {{ page }} / {{ pages }}</span>
        {% if page < pages %}
          <a class="btn btn-secondary" href="/contacts?page={{ page + 1 }}&per_page={{ per_page }}">Next ‚Üí</a>
        {% endif %}
      </div>
    </div>
  {% endif %}
</section>

<!-- Modal -->
<dialog id="contactDialog" class="modal">
  <form method="post" action="/contacts" class="card" id="contactForm">
    <h3>‚ûï Create Contact</h3>

    <label class="lbl">Full name</label>
    <input class="inp" type="text" name="full_name" placeholder="e.g., Md. Rahim" required>

    <label class="lbl">Mobile (BD)</label>
    <div class="input-row">
      <input class="inp" type="text" name="mobile_input" id="mobile_input"
             value="+880" required
             pattern="^\+8801[3-9]\d{8}$"
             title="Use +8801XXXXXXXXX">
      <small class="muted">Format: +8801XXXXXXXXX</small>
    </div>

    <label class="lbl">Remark</label>
    <textarea class="inp" name="remark" rows="3" placeholder="Optional short note‚Ä¶"></textarea>

    <div class="modal-actions">
      <button type="button" class="btn" id="btnCloseContact">Cancel</button>
      <button type="submit" class="btn btn-primary">Save</button>
    </div>
  </form>
</dialog>

<style>
  .page-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
  .table-wrap { overflow:auto; border-radius:12px; border:1px solid var(--border-color, #1f2b3a); }
  .table { width:100%; border-collapse:separate; border-spacing:0; }
  .table th, .table td { padding:.9rem 1rem; border-bottom:1px solid var(--border-color, #1f2b3a); }
  .table thead th { font-weight:600; color:var(--text-weak,#9fb3c8); background:var(--panel,#0f1722); }
  .pager { margin-top:1rem; display:flex; justify-content:space-between; align-items:center; }
  .modal::backdrop { background: rgba(0,0,0,.55); }
  .modal .card { width:min(560px, 92vw); padding:1.25rem; border-radius:16px; background:var(--panel,#0f1722); border:1px solid var(--border-color,#1f2b3a); }
  .lbl { display:block; margin:.5rem 0 .35rem; font-weight:600; }
  .inp { width:100%; padding:.7rem .8rem; border-radius:10px; border:1px solid var(--border-color,#1f2b3a); background:var(--panel,#0f1722); color:var(--text,#e3edf7); }
  .input-row small { display:block; margin-top:.25rem; }
  .modal-actions { display:flex; justify-content:flex-end; gap:.6rem; margin-top:1rem; }
</style>

<script>
  const dlg = document.getElementById('contactDialog');
  const openBtn = document.getElementById('btnOpenContact');
  const closeBtn = document.getElementById('btnCloseContact');
  const mobileInput = document.getElementById('mobile_input');

  openBtn?.addEventListener('click', () => {
    if (!mobileInput.value || !mobileInput.value.startsWith('+880')) {
      mobileInput.value = '+880';
    }
    dlg.showModal();
    mobileInput.focus();
  });
  closeBtn?.addEventListener('click', () => dlg.close());

  // Prevent users from deleting the +880 prefix entirely
  mobileInput?.addEventListener('input', () => {
    if (!mobileInput.value.startsWith('+880')) {
      mobileInput.value = '+880';
    }
  });
</script>
{% endblock %}
